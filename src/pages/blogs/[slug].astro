---
import BlogPostLayout from "../../layouts/BlogPostLayout.astro";
import Breadcrumb from "../../components/blog/Breadcrumb.astro";
import BlogPostHeader from "../../components/blog/BlogPostHeader.astro";
import ShareButtons from "../../components/blog/ShareButtons.astro";
import AuthorInfo from "../../components/blog/AuthorInfo.astro";
import RelatedPosts from "../../components/blog/RelatedPosts.astro";
import BackButton from "../../components/blog/BackButton.astro";
import { getCollection } from 'astro:content';

const BASE_URL = import.meta.env.BASE_URL;

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
const { data } = post;

// Get related posts (same category)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === data.category && !p.data.draft)
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
  .slice(0, 3);
---

<BlogPostLayout pageTitle={data.title}>
  <!-- Breadcrumb Navigation -->
  <Breadcrumb title={data.title} />

  <!-- Article Header with Metadata -->
  <BlogPostHeader
    title={data.title}
    category={data.category}
    featured={data.featured}
    author={data.author}
    publishDate={data.publishDate}
    readTime={data.readTime}
    image={data.image}
    description={data.description}
    tags={data.tags}
  />

  <!-- Article Content -->
  <div class="max-w-3xl mx-auto">
    <div class="blog-content">
      <Content />
    </div>
  </div>

  <!-- Article Footer -->
  <footer class="max-w-3xl mx-auto mt-16 pt-8 border-t border-gray-200">
    <!-- Share Buttons -->
    <ShareButtons title={data.title} />

    <!-- Author Information -->
    <AuthorInfo
      author={data.author}
      publishDate={data.publishDate}
      updatedDate={data.updatedDate}
    />
  </footer>

  <!-- Related Posts Section -->
  <RelatedPosts posts={relatedPosts} />

  <!-- Back to Blog Button -->
  <BackButton href={`${BASE_URL}blogs`} />
</BlogPostLayout>
