---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';

// Get all products
const allProducts = await getCollection('products');

// Sort products by creation date (newest first)
const products = allProducts.sort((a, b) =>
  new Date(b.data.createdAt).getTime() - new Date(a.data.createdAt).getTime()
);

// Get unique categories and brands for filtering
const categories = [...new Set(products.map(product => product.data.category))];
const brands = [...new Set(products.map(product => product.data.brand))];
---

<BaseLayout pageTitle="Products">
  <!-- Hero Section -->
  <section class="bg-gradient-to-r from-green-50 to-blue-50 py-16 px-4">
    <div class="container mx-auto text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">Our Products</h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Discover our curated collection of high-quality products designed to enhance your lifestyle
      </p>
    </div>
  </section>

  <!-- Filters and Search -->
  <section class="py-8 px-4 bg-white border-b border-gray-200">
    <div class="container mx-auto">
      <div class="flex flex-col lg:flex-row gap-6 items-start lg:items-center justify-between">
        <!-- Search Bar -->
        <div class="flex-1 max-w-md">
          <div class="relative">
            <input
              type="text"
              id="searchInput"
              placeholder="Search products..."
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            />
            <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap gap-4">
          <!-- Category Filter -->
          <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="">All Categories</option>
            {categories.map(category => (
              <option value={category}>{category}</option>
            ))}
          </select>

          <!-- Brand Filter -->
          <select id="brandFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="">All Brands</option>
            {brands.map(brand => (
              <option value={brand}>{brand}</option>
            ))}
          </select>

          <!-- Sort By -->
          <select id="sortFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
            <option value="name">Name A-Z</option>
          </select>

          <!-- Clear Filters -->
          <button
            id="clearFilters"
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200"
          >
            Clear All
          </button>
        </div>
      </div>

      <!-- Results Count -->
      <div class="mt-4">
        <p id="resultsCount" class="text-gray-600">
          Showing {products.length} products
        </p>
      </div>
    </div>
  </section>

  <!-- Products Grid -->
  <section class="py-12 px-4">
    <div class="container mx-auto">
      <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        {products.map((product) => (
          <div
            class="product-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 group"
            data-category={product.data.category}
            data-brand={product.data.brand}
            data-name={product.data.name.toLowerCase()}
            data-price={product.data.price}
            data-created={product.data.createdAt}
          >
            <div class="relative">
              <a href={`/products/${product.id}`}>
                <img
                  src={product.data.images[0].url}
                  alt={product.data.images[0].alt}
                  class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </a>

              {product.data.badge && (
                <span class="absolute top-4 left-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                  {product.data.badge}
                </span>
              )}

              {product.data.originalPrice && (
                <span class="absolute top-4 right-4 bg-red-500 text-white px-2 py-1 rounded text-sm font-semibold">
                  SALE
                </span>
              )}

              {!product.data.inStock && (
                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                  <span class="bg-white text-gray-800 px-4 py-2 rounded-lg font-semibold">
                    Out of Stock
                  </span>
                </div>
              )}
            </div>

            <div class="p-6">
              <!-- Brand -->
              <p class="text-sm text-gray-500 mb-2">{product.data.brand}</p>

              <!-- Product Name -->
              <h3 class="text-lg font-semibold text-gray-800 mb-3 line-clamp-2">
                <a href={`/products/${product.id}`} class="hover:text-green-600 transition-colors duration-200">
                  {product.data.name}
                </a>
              </h3>

              <!-- Rating -->
              {product.data.rating && (
                <div class="flex items-center mb-3">
                  <div class="flex text-yellow-400">
                    {Array.from({ length: 5 }, (_, i) => (
                      <svg
                        class={`h-4 w-4 ${i < Math.floor(product.data.rating) ? 'fill-current' : 'text-gray-300'}`}
                        viewBox="0 0 20 20"
                      >
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                    ))}
                  </div>
                  <span class="ml-2 text-sm text-gray-600">
                    ({product.data.reviewCount})
                  </span>
                </div>
              )}

              <!-- Price -->
              <div class="flex items-center gap-3 mb-4">
                <span class="text-2xl font-bold text-green-600">
                  ${product.data.price.toFixed(2)}
                </span>
                {product.data.originalPrice && (
                  <span class="text-gray-500 line-through">
                    ${product.data.originalPrice.toFixed(2)}
                  </span>
                )}
              </div>

              <!-- Add to Cart Button -->
              <button
                class={`w-full py-3 rounded-lg font-semibold transition-colors duration-200 ${
                  product.data.inStock
                    ? 'bg-gray-800 text-white hover:bg-gray-900'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }`}
                disabled={!product.data.inStock}
              >
                {product.data.inStock ? 'Add to Cart' : 'Out of Stock'}
              </button>
            </div>
          </div>
        ))}
      </div>

      <!-- No Results Message -->
      <div id="noResults" class="hidden text-center py-12">
        <svg class="mx-auto h-24 w-24 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.5-.81-6.172-2.172C5.83 12.83 6 12.91 6 13.09V19a2 2 0 002 2h8a2 2 0 002-2v-5.91c0-.18.17-.26.172-.262A7.962 7.962 0 0112 15z"/>
        </svg>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">No products found</h3>
        <p class="text-gray-600 mb-4">Try adjusting your search or filter criteria</p>
        <button
          onclick="clearAllFilters()"
          class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200"
        >
          Clear All Filters
        </button>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Get all filter elements
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');
  const brandFilter = document.getElementById('brandFilter');
  const sortFilter = document.getElementById('sortFilter');
  const clearFiltersBtn = document.getElementById('clearFilters');
  const resultsCount = document.getElementById('resultsCount');
  const productsGrid = document.getElementById('productsGrid');
  const noResults = document.getElementById('noResults');

  // Get all product cards
  const productCards = Array.from(document.querySelectorAll('.product-card'));

  // Filter and sort function
  function filterAndSortProducts() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const selectedCategory = categoryFilter.value;
    const selectedBrand = brandFilter.value;
    const sortBy = sortFilter.value;

    // Filter products
    let filteredCards = productCards.filter(card => {
      const matchesSearch = !searchTerm || card.dataset.name.includes(searchTerm);
      const matchesCategory = !selectedCategory || card.dataset.category === selectedCategory;
      const matchesBrand = !selectedBrand || card.dataset.brand === selectedBrand;

      return matchesSearch && matchesCategory && matchesBrand;
    });

    // Sort products
    filteredCards.sort((a, b) => {
      switch (sortBy) {
        case 'newest':
          return new Date(b.dataset.created) - new Date(a.dataset.created);
        case 'oldest':
          return new Date(a.dataset.created) - new Date(b.dataset.created);
        case 'price-low':
          return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
        case 'price-high':
          return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
        case 'name':
          return a.dataset.name.localeCompare(b.dataset.name);
        default:
          return 0;
      }
    });

    // Hide all cards first
    productCards.forEach(card => card.style.display = 'none');

    // Show filtered cards
    filteredCards.forEach(card => card.style.display = 'block');

    // Update results count
    resultsCount.textContent = `Showing ${filteredCards.length} products`;

    // Show/hide no results message
    if (filteredCards.length === 0) {
      noResults.classList.remove('hidden');
      productsGrid.style.display = 'none';
    } else {
      noResults.classList.add('hidden');
      productsGrid.style.display = 'grid';
    }
  }

  // Clear all filters function
  function clearAllFilters() {
    searchInput.value = '';
    categoryFilter.value = '';
    brandFilter.value = '';
    sortFilter.value = 'newest';
    filterAndSortProducts();
  }

  // Event listeners
  searchInput.addEventListener('input', filterAndSortProducts);
  categoryFilter.addEventListener('change', filterAndSortProducts);
  brandFilter.addEventListener('change', filterAndSortProducts);
  sortFilter.addEventListener('change', filterAndSortProducts);
  clearFiltersBtn.addEventListener('click', clearAllFilters);

  // Make clearAllFilters globally available
  window.clearAllFilters = clearAllFilters;

  // Initial filter on page load
  filterAndSortProducts();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
